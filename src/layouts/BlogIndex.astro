---
import FormattedDate from '@components/FormattedDate.astro';
import { Image } from 'astro:assets';
import { formatDescription, titleLineCountIsOne } from '@utils/abbreviateDescription';
import BaseLayout from '@layouts/BaseLayout.astro';
import { customGetCollection } from '@utils/customGetCollection';

const { blogCollectionName, basePath } = Astro.props;
const blogCollection = await customGetCollection(blogCollectionName, basePath);
let posts = blogCollection.sort((a, b) => {
	// Sort by modifiedDate if available, otherwise fall back to pubDate
	const dateA = a.props.data.update ? new Date(a.props.data.update) : new Date(a.props.data.pubDate);
	const dateB = b.props.data.update ? new Date(b.props.data.update) : new Date(b.props.data.pubDate);
	// Sort in descending order (newest first)
	return dateB.valueOf() - dateA.valueOf();
});
// 按年份分组
let postsByYear = {};
posts.forEach(post => {
	const date = post.props.data.update ? new Date(post.props.data.update) : new Date(post.props.data.pubDate);
	const year = date.getFullYear();
	if (!postsByYear[year]) postsByYear[year] = [];
	postsByYear[year].push(post);
});
const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
const heroImage = posts.length > 0 ? posts[0].props.data.heroImage : undefined;
const heroAlt = posts.length > 0 ? posts[0].props.data.heroAlt : undefined;
---

<BaseLayout
	pageTitle="All posts"
	pageDescription="This page is an index of all blog posts."
	heroImage={heroImage}
	heroAlt={heroAlt}
>
	{years.map(year => (
		<div>
			<h2 class="mt-8 mb-2 text-xl font-bold text-semantic-primary">{year}</h2>
			<ul class="flex w-full max-w-[92svw] mx-auto list-none flex-col items-start px-4 py-3 sm:hidden">
				{postsByYear[year].map((post, i) => (
					<>
						<li class="flex w-full flex-col py-3">
							<a
								class="group flex h-full min-w-full items-center justify-between hover:no-underline"
								href={`${post.params.htmlSlug}`}
							>
								<div class="flex h-full w-full flex-col justify-start ">
									<div class="text-xs font-medium text-semantic-on-background/60 ">
										<FormattedDate
											date={post.props.data.update ? new Date(post.props.data.update) : new Date(post.props.data.pubDate)}
										/>
									</div>
									<div class="flex w-full justify-between gap-3">
										<div class="flex w-max flex-col">
											<h1 class="line-clamp-2 hyphens-auto break-words text-base font-semibold leading-5 group-hover:text-semantic-primary ">
												{post.props.data.title}
											</h1>
											{titleLineCountIsOne(post.props.data.title) ? (
												<p class="line-clamp-3 text-xs ">
													{formatDescription(post.props.data.description, post.props.body, 3, 100)}
												</p>
											) : (
												<p class="line-clamp-2 text-xs ">
													{formatDescription(post.props.data.description, post.props.body, 2, 100)}
												</p>
											)}
										</div>
										<div class="m-1 ml-3 aspect-square h-24 max-h-28 flex-shrink-0 rounded-lg overflow-hidden">
											{post.props.data.heroImage ? (
												<Image
													class="h-full w-full rounded-lg object-cover"
													src={post.props.data.heroImage}
													alt={post.props.data.heroAlt || ''}
												/>
											) : (
												<div class="h-full w-full rounded-xl bg-semantic-primary-container/20" />
											)}
										</div>
									</div>
									<div class="mb-auto mt-3 text-xs font-normal italic text-semantic-on-background/60 ">
										{[post.props.data.readingTime]}
									</div>
									{postsByYear[year].length != i + 1 && <hr class="my-2 mt-auto w-full border-semantic-on-surface-variant/10" />}
								</div>
							</a>
						</li>
					</>
				))}
			</ul>
			<ul class="hidden sm:flex w-full list-none flex-col items-start py-4 md:hidden">
				{postsByYear[year].map((post, i) => (
					<>
						<li class="flex h-[11rem] w-full flex-col ">
							<a class="group flex h-full items-center justify-between hover:no-underline" href={`${post.params.htmlSlug}`}>
								<div class="flex h-full w-full flex-col justify-start ">
									<div class="text-xs font-medium text-semantic-on-background/60">
										<FormattedDate
											date={post.props.data.update ? new Date(post.props.data.update) : new Date(post.props.data.pubDate)}
										/>
									</div>
									<div class="flex h-[6.25rem] w-full justify-between ">
										<div class="flex w-max flex-col">
											<h1 class="line-clamp-2  break-words text-base font-semibold leading-5 group-hover:text-semantic-primary  ">
												{post.props.data.title}
											</h1>
											{titleLineCountIsOne(post.props.data.title) ? (
												<p class="line-clamp-4 text-xs ">{formatDescription(post.props.data.description, post.props.body)}</p>
											) : (
												<p class="line-clamp-3 text-xs ">{formatDescription(post.props.data.description, post.props.body)}</p>
											)}
										</div>
										<div class="ml-6 aspect-square h-full flex-shrink-0 p-1">
											{post.props.data.heroImage ? (
												<Image
													class="h-full rounded-xl object-cover "
													src={post.props.data.heroImage}
													alt={post.props.data.heroAlt || ''}
												/>
											) : (
												<div class="h-full w-full rounded-xl bg-semantic-primary-container/20" />
											)}
										</div>
									</div>
									<div class="mb-auto mt-3 text-xs font-normal italic text-semantic-on-background/60 ">
										{[post.props.data.readingTime]}
									</div>
									{postsByYear[year].length != i + 1 && <hr class="my-2 mt-auto w-full border-semantic-on-surface-variant/10" />}
								</div>
							</a>
						</li>
					</>
				))}
			</ul>
		</div>
	))}
</BaseLayout>
<style>
	a {
		color: theme(colors.semantic.on-background);
	}
</style>
